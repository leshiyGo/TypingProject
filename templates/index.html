{% extends 'template.html' %}
{% block title %}–í—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ{% endblock %}
{% block body %}
    <style>
    header {
        --bs-border-color: #ffffff;
    }
    #sentence {
        visibility: hidden;
        font-size: 20px;
        font-weight: bold;
    }
    body {
        text-align: center;
        background-image: url('https://www.chicagoveininstitute.com/wp-content/uploads/2019/07/desk-job-effect-on-vein-health.jpg');
        background-size: cover;
        background-repeat: no-repeat;
        position: relative;
    }
    .container {
        border-radius: 0.4em;
    }
    @keyframes move {
        from {
            top: -30%;
            left: 30.5%;
            opacity: 0;
        }
        to {
            top: 110%;
            left: 30.5%;
            opacity: 1;
        }
    }
    @keyframes slideUp {
        from {
            bottom: -150%;
            left: 38%;
            opacity: 0;
        }
        to {
            bottom: -102%;
            left: 38%;
            opacity: 1;
        }
    }
    .results {
        text-align: center;
        visibility: hidden;
        width: 665.45px;
        height: 250px; /* –í—ã—Å–æ—Ç–∞ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ */
        background: #fbfbfb;
        border-radius: 10px; /* –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∞–µ–≤ */
        box-shadow: 0 8px 10px rgba(0, 0, 0, 0.247); /* –¢–µ–Ω—å */
        position: absolute;
        top: 50%;
        left: 5%;
    }

    .text { 
        text-align: left;
        border-bottom: 1px solid #eee;
        border-radius: 6px 6px 0 0;
        padding: 9px 15px;
    }
    
    .center {
        text-align: center;
    }

    .result_block {
        display: inline-block;
        text-align: left;
    }

    .result_block h6 {
        color: #777;
        font-size: 12px;
        font-weight: 700;
        line-height: 1;
        margin-top: 7px;
        margin-bottom: 0rem;
    }
    .pic {
        display: inline-block;
        font-size: 30px;
        vertical-align: top;
    }
    .result_block div {
        display: inline-block;
        margin: 5px 0 0 5px;
    }
    .fun_text {
        padding: 1% 3% 0 3%;
        color: #000000;
        font-size: 17px;
        font-weight: bold;
        word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
        white-space: normal;
    }
    #theEnd {
        font-weight: 600;
    }
    #mistakes {
        font-size: large;
    }
    #start {
        font-size: larger;
    }
    .buttons {
        width: 520px;
        text-align: right;
        visibility: hidden;
        position: absolute;
    }
    .but {
        cursor: pointer;
        font-size: 20px;
        color: white;
        text-align: center;
        width: 130px;
        height: 32px;
        border-radius: 0.375rem;
        background-color: #0d6efd;
        --bs-border-radius-sm: 0.25rem;
        --bs-border-radius-lg: 0.5rem;
        --bs-border-radius-xl: 1rem;
        --bs-border-radius-xxl: 2rem;
        margin: 0 1% 0 0;
        display: inline-block;
    }
    .but:hover {
        background-color: #0d48d1;
    }
    #complete {
        background-color: rgb(231, 30, 30);
    }
    #complete:hover {
        background-color: rgb(174, 25, 25);
    }
    #save {
        background-color: rgb(44, 228, 44);
    }
    #save:hover {
        background-color: rgb(34, 161, 34);
    }
    .Text {
        position:absolute;
        visibility: hidden;
    }
    </style>
<div class="Text">{{ user_in_sess }}</div>

<div class="main_container">
    <p id="start">
        {% if level_id %}
        –£—Ä–æ–≤–µ–Ω—å :
        {% else %}

        {% endif %}
        <span id="id_of_level">
            {{ level_id }}
        </span>
        –ù–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—á–∞—Ç—å (Space)
    </p>
    <p id="sentence">
        {% if sentence%}
            {{ sentence }}
        {% else %}
        –£–∑–Ω–∞–π —Å–≤–æ—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏, –Ω–∞–ø–∏—Å–∞–≤ —ç—Ç–æ—Ç –Ω–µ–±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç. –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —É—Ä–æ–≤–Ω—è–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –∏–ª–∏ –≤–æ–π–¥–∏ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç.
        {% endif %}
    </p>
    <input id="correctText">
    <div><b id="timer">0:00</b></div>
    <p id="mistakes"></p>
    <p id="theEnd"></p>
</div>
<form method="post">
<div class="results" id="results">
    <div class="text">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="center">
        <div class="result_block" id="accuracy" style="padding: 0px 25px 0px 0px;">
            <div class="pic">üéØ</div>
            <div>
                <h6>–ê–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å</h6>
                <b><span id="show_accuracy"></span>%</b>
            </div>
        </div>
        <div class="result_block" id="speed" style="padding: 0px 25px 0px 0px;">
            <div class="pic">üèéÔ∏è</div>
            <div>
                <h6>–°–∫–æ—Ä–æ—Å—Ç—å</h6>
                <b><span id="show_speed"></span> –∑–Ω./–º–∏–Ω.</b>
            </div>
        </div>
        <div class="result_block" id="correct_text" style="padding: 0px 25px 0px 0px;">
            <div class="pic">‚úî</div>
            <div>
                <h6>–ü—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–±—Ä–∞–Ω–æ</h6>
                <b><span id="show_cor"></span></b>
            </div>
        </div>
        <div class="result_block" id="incorrect_text" style="padding: 0 10px 0 0;">
            <div class="pic">‚ùå</div>
            <div>
                <h6>–û—à–∏–±–æ–∫</h6>
                <b><span id="show_incor"></span></b>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="text">–•–∞—Ä–∞–∫—Ç–µ—Ä –Ω–∞–±–æ—Ä–∞:</div>
        <div class="fun_text"></div>
    </div>
    </div>
</form>
<div class="buttons" id="buttons">
    <div class="but" id="complete" type="submit">–ó–∞–≤–µ—Ä—à–∏—Ç—å</div>
    <div class="but" id="again" type="submit" style="width: 170px;">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</div>
    <div class="but" id="save" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div>
</div>

{% endblock %}
{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var sentenceElement = document.getElementById("sentence");
        var currentPosition = 0;
        var Flag = false;
        var timerInterval, allTime, incorrectLetters = 0, correctLetters = 0;
        var mistakes = document.getElementById('mistakes');
        var input = document.getElementById('correctText');
        var accuracy = document.getElementById('show_accuracy');
        var speed_block = document.getElementById('show_speed');
        var correct_text = document.getElementById('show_cor');
        var incorrect_text = document.getElementById('show_incor');
        var start_text = document.getElementById('start');
        var buttons = document.querySelector('.buttons');
        var fun_text = document.querySelector('.fun_text');
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
        var results = document.querySelector('.results');

    function showResults() {
        setTimeout(function() {
        document.getElementById('results').classList.add('show');
        }, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 100 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    }

    var sentence = sentenceElement.textContent.trim();
    function init() {
        sec = 0;
        min = 0;
        timerInterval = setInterval(tick, 1000);
    }
    function tick() {
        sec++;
        if (sec === 60) {
            sec = 0;
            min++;
        }
        var timerElement = document.getElementById("timer");
        timerElement.textContent = min + ":" + (sec < 10 ? "0" : "") + sec;
    }

    document.getElementById('again').addEventListener('click', function() {
            location.reload();
        });
        
    input.addEventListener("input", function() {
        if (Flag === true) {
            var inputValue = input.value;
            if (inputValue.length > sentence.length) {
                input.value = inputValue.slice(0, sentence.length);
                return;
            }
            if (inputValue !== sentence.slice(0, inputValue.length)) {
                input.value = inputValue.slice(0, -1);
                incorrectLetters++;
                sentenceElement.innerHTML = "<span style='color: red;'>" + sentence[currentPosition] + "</span>" + sentence.slice(currentPosition + 1);
                mistakes.textContent = ("–û—à–∏–±–∫–∏: " + incorrectLetters);
            } else {
                currentPosition++;
                correctLetters++;
                if (currentPosition === sentence.length) {
                    sentenceElement.textContent = sentence.slice(0, -1);
                    theEnd.textContent = ("–í—ã –≤–≤–µ–ª–∏ –≤—Å–µ –±—É–∫–≤—ã –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è");
                    clearInterval(timerInterval);
                    allTime = min * 60 + sec;
                    input.blur();
                    const speed = Math.round((input.value.length/allTime)*60);
                    accuracy.textContent = parseFloat((correctLetters / (correctLetters + incorrectLetters)) * 100).toFixed(1);
                    speed_block.textContent = speed;
                    correct_text.textContent = correctLetters;
                    incorrect_text.textContent = incorrectLetters; 
                    //body.style = 'filter : blur(8px)';
                    results.style = 'visibility : visible; animation : move 1s forwards';
                    buttons.style.animation = 'slideUp 1s forwards';
                    buttons.style.visibility = 'visible';
                    if (speed < 120) {
                        fun_text.innerHTML = '–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–∞—è –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, –∏–º–µ—é—â–µ–≥–æ –Ω–µ–±–æ–ª—å—à–æ–π –æ–ø—ã—Ç –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ';
                    } else if (speed >= 120 && speed <= 160) {
                        fun_text.innerHTML = '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ —Å—Ä–µ–¥–Ω–µ—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –Ω–∞–±–∏—Ä–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç 2-4 –ø–∞–ª—å—Ü–∞–º–∏, –ø–æ–¥–≥–ª—è–¥—ã–≤–∞—è –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É';
                    } else if (speed > 160 && speed < 260) {
                        fun_text.innerHTML = '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–ª–∞–¥–µ–µ—Ç –Ω–∞–≤—ã–∫–æ–º —Å–ª–µ–ø–æ–≥–æ –¥–µ—Å—è—Ç–∏–ø–∞–ª—å—Ü–µ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞ –Ω–∞–±–æ—Ä–∞';
                    } else if (speed >= 260 && speed <= 350) {
                        fun_text.innerHTML = '–•–æ—Ä–æ—à–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—à–µ–ª –æ–±—É—á–µ–Ω–∏–µ –ø–æ –∫—É—Ä—Å—É —Å–ª–µ–ø–æ–π –ø–µ—á–∞—Ç–∏ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –∏–ª–∏ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–±–æ—Ä–∞ —Å –ø–æ–º–æ—â—å—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–≥–æ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–∞';
                    } else if (speed > 350 && speed < 400) {
                        fun_text.innerHTML = '–°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ –≤–ª–∞–¥–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π';
                    } else {
                        fun_text.innerHTML = '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏, –±–ª–∏–∑–∫–∞—è –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–µ—á–∏';
                    }
                } else {
                    sentenceElement.innerHTML = sentence.slice(currentPosition);
                }
            }
        }
    });

    document.getElementById('complete').addEventListener('click', function() {
        const user_in_sess= document.getElementsByClassName('Text').textContent;
            if (user_in_sess == false){
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = '/register';
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É, –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                window.location.href = '/levels_page';
            }
        });

    document.getElementById('save').addEventListener('click', function() {
        const speed_inf = document.getElementById('show_speed').textContent;
        const accuracy_inf = document.getElementById('show_accuracy').textContent;
        const correctText_inf = document.getElementById('show_cor').textContent;
        const incorrectText_inf = document.getElementById('show_incor').textContent;
        const id_of_lvl = document.getElementById('id_of_level').textContent;
        const data = {
            id_level: parseInt(id_of_lvl),
            speed: parseInt(speed_inf),
            accuracy: parseFloat(accuracy_inf),
            correct_text: parseInt(correctText_inf),
            incorrect_text: parseInt(incorrectText_inf)
        };
        
        const levelId = parseInt(document.getElementById('id_of_level').textContent);
        if (!levelId) {
            alert("–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ. –í—ã –Ω–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.")
        }
        else {
            fetch('/save_results', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } else {
                alert('Failed to save results.');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
        }
        
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞
    document.getElementById("correctText").addEventListener("keydown", function(event) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∞—Ç–∞ –ª–∏ –∫–ª–∞–≤–∏—à–∞ Backspace
        if (event.key === "Backspace") {
            event.preventDefault();
        }
    });
    document.addEventListener("keydown", function(event) {
        if (event.key === ' ' && !Flag) {
            event.preventDefault();
            input.focus();
            Flag = true;
            init();
            sentenceElement.style.visibility = 'visible';
            start_text.style.visibility = 'hidden'; 
        }
    });
});
</script>
{% endblock %}
